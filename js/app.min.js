$(function(){window.Location=Backbone.Model.extend({defaults:{label:0,showOnMap:!1,showInfowindow:!1,marker:null},initialize:function(){var a=this.toJSON();this.set({marker:new google.maps.Marker({position:new google.maps.LatLng(parseFloat(a.lat),parseFloat(a.lng)),title:a.name,map:null,icon:"http://maps.google.com/mapfiles/marker"+String.fromCharCode(a.label+65)+".png"})})}});window.LocationCollection=Backbone.Collection.extend({model:Location,url:"ajax/markercache.json",initialize:function(){this.bind("change:label",
this.updateMarkerIcon)},searchByQuery:function(a){var b=a.split(" ");return null!==a.match(/^"[\w\s]*/i)?(a=a.slice(1,a.length-1),this.filter(function(b){return null!==b.get("name").match(a)})):this.filter(function(a){for(var c=0;c<b.length;c++){var e=RegExp(b[c],"i");if(e.test(a.get("name"))||e.test(a.get("address"))||e.test(a.get("id"))||-1!==_.indexOf(a.get("departments"),b[c]))return!0}return!1})},searchById:function(a){return this.filter(function(b){return parseInt(b.get("id"))===parseInt(a)})},
getShownMarkers:function(){return this.filter(function(a){return null!==a.get("marker").getMap()})},removeShownMarkers:function(){var a=this.getShownMarkers();0<a.length&&_.each(a,function(a){var d=a.get("marker");a.set({showOnMap:!1,showInfowindow:!1});d.setMap(null);google.maps.event.clearListeners(d,"click")})},updateMarkerIcon:function(a){var b=a.get("marker"),a=a.get("label");b.setIcon("http://maps.google.com/mapfiles/marker"+String.fromCharCode(a+65)+".png")}});window.MapView=Backbone.View.extend({el:$("#map-canvas"),
map:null,kmlVersion:"1.4",layers:{kml:[]},markers:[],infowindow:null,initialize:function(){var a=this,b="http://www.millersville.edu/directions/kml/mobile/marker-dump.kml?v="+this.kmlVersion;this.map=new google.maps.Map(this.el[0],{zoom:16,zoomControl:!0,panControl:!0,center:new google.maps.LatLng(39.996635,-76.353929),mapTypeId:google.maps.MapTypeId.ROADMAP});this.collection.bind("change:showOnMap",this.addMarker,this);this.collection.bind("change:showInfowindow",this.openMarkerInfowindow,this);
this.layers.kml.baseLayer=new google.maps.KmlLayer(b,{suppressInfoWindows:!1,preserveViewport:!0});this.layers.kml.baseLayer.setMap(this.map);$("#filter-map").on("change","input.filter-checkbox",function(){var b=["academicsLayer","administrativeLayer","dormLayer"];if(!0==this.checked){var c=-1!=this.value.indexOf("building")?!0:!1;a.showKmlLayer(this.id,{url:"http://www.millersville.edu/directions/kml/"+this.value+".kml",suppressInfoWindows:c,preserveViewport:!0});if("baseLayer"!=this.id&&c&&!0==
document.getElementById("baseLayer").checked)document.getElementById("baseLayer").checked=!1,a.removeKmlLayer("baseLayer");else if("baseLayer"==this.id)for(c=0;c<b.length;c++)!0==document.getElementById(b[c]).checked&&(document.getElementById(b[c]).checked=!1,a.removeKmlLayer(b[c]))}else a.removeKmlLayer(this.id)})},resizeMap:function(){google.maps.event.trigger(this.map,"resize")},addMarker:function(a){var b=this,d=a.toJSON(),c=d.marker;c.setMap(this.map);google.maps.event.addListener(c,"click",
function(){var e=new google.maps.InfoWindow({content:d.infoWindow.content,position:c.getPosition()});google.maps.event.addListener(e,"closeclick",function(){a.set({showInfowindow:!1})});b.setInfoWindow(e);e.open(b.map,c)})},openMarkerInfowindow:function(a){var b=a.get("marker");!0===a.get("showInfowindow")&&null!==b.getMap()?google.maps.event.trigger(b,"click"):this.setInfoWindow(null)},setInfoWindow:function(a){null!==this.infowindow&&this.infowindow.close();this.infowindow=a},showKmlLayer:function(a,
b){void 0===this.layers.kml[a]&&(this.layers.kml[a]=new google.maps.KmlLayer(b.url+"?v="+this.kmlVersion,{suppressInfoWindows:b.suppressInfoWindows,preserveViewport:b.preserveViewport}));this.layers.kml[a].setMap(this.map)},removeKmlLayer:function(a){this.layers.kml[a].setMap(null)}});window.PanelView=Backbone.View.extend({el:$("#panel-wrapper"),statsTemplate:_.template($("#search-results-stats").html()),resultsTemplate:_.template($("#search-results-item").html()),shareFieldsTemplate:_.template($("#share-fields").html()),
searchResults:[],searchOpts:{curPage:1,totalPages:1,pageSize:6},routeUrl:"",events:{},initialize:function(){var a=this;this.input=this.$("#kwsearch-keyword");this.selectbox=this.$("#bldgsearch-select");this.deepLinksIds=[];$("#options-nav-bar").find("a:first").addClass("selected");$("#map-search").show();0===a.searchResults.length&&$("#map-overlays").show();$("#options-nav-bar").on("click","a.btn",function(){$("#options-nav-bar").find("a").removeClass("active");$(this).addClass("active");$("fieldset",
$("#marker-search")).hide();$("#sharedlink").blur();switch(this.id){case "tablink-mapoptions":$("#map-search, #link").hide();$("#map-overlays").show();break;case "tablink-link":$("#map-search, #map-overlays").hide();$("#link").show();$("#sharedlink").focus().select();break;default:$("#link").hide(),$("#map-search").show(),$("fieldset"+$(this).attr("href"),$("#marker-search")).show(),0===a.searchResults.length?$("#map-overlays").show():$("#map-overlays").hide()}return!1})},setCurrentPage:function(a){this.searchOpts.curPage=
"number"!==typeof a||1>a||a>this.searchOpts.totalPages?1:a},searchByKeyword:function(a,b){this.input.val(a);this.searchResults=this.collection.searchByQuery(a);this.searchOpts.totalPages=Math.ceil(this.searchResults.length/this.searchOpts.pageSize);this.setCurrentPage(b);this.selectbox[0].selectedIndex=0;this.updateResults();return!1},searchByIDs:function(a){var b=0;this.searchResults=[];for(this.deepLinksIds=a||[];b<this.deepLinksIds.length;b++){var d=this.collection.get(this.deepLinksIds[b]);void 0!==
d&&this.searchResults.push(d)}1===this.searchResults.length?(this.input.val('"'+this.searchResults[0].get("name")+'"'),this.selectbox.val(a[0])):(this.input.val(""),this.selectbox[0].options.selectedIndex=0);this.searchOpts.totalPages=Math.ceil(this.searchResults.length/this.searchOpts.pageSize);this.updateResults()},updateResults:function(){var a=this,b=this.searchOpts.curPage;Math.ceil(this.searchResults.length/this.searchOpts.pageSize);var d="",c=(b-1)*this.searchOpts.pageSize,e=c+this.searchOpts.pageSize,
e=e<=this.searchResults.length?e:this.searchResults.length;$("#map-overlays").css({display:"none"});$(".kwsearch-clear").css({display:"block"});if(1>this.searchResults.length)$("#map-results").html('<div class="alert alert-block"><p>No results were found for <strong><em>'+(""!==this.selectbox.val()?this.selectbox.val():this.input.val())+"</em></strong>.<br /><br />Please make sure building or department names are spelled correctly.</p></div>");else{d='<ul id="results-page-'+b+'" class="page active">';
for(b=c;b<e;b++)d+=this.resultsTemplate({id:this.searchResults[b].id,label:b%this.searchOpts.pageSize,marker:this.searchResults[b].toJSON()});d+="</ul>";$("#map-results-stats").html(this.statsTemplate({lowerBound:c,upperBound:e,resultCount:this.searchResults.length,query:this.input.val()}));$("#map-results").html(d);$("#map-results li").on("click","a",function(){a.collection.get(this.id.replace("result-","")).set({showInfowindow:!0});return!1});$("#map-results-pagination").html(this.renderPagination());
for(b=c;b<e;b++)this.collection.get(this.searchResults[b].id).set({showOnMap:!0,showInfowindow:1===this.searchResults.length?!0:!1,label:b%this.searchOpts.pageSize})}$("#map-results-wrap").css({display:"block"})},clearResults:function(){$("#map-results-pagination, #map-results-feedback, #map-results").html("");$("#map-results-wrap, .kwsearch-clear").css({display:"none"});$("#map-overlays").css({display:"block"});this.input.val("");this.selectbox[0].options.selectedIndex=0;this.searchOpts.curPage=
1;this.searchResults=[]},renderPagination:function(){var a=1>=this.searchOpts.curPage?1:parseInt(this.searchOpts.curPage),b="<ul>",d=this.routeUrl+"p",c=function(b,c){for(var g="",f=b;f<=c;f++)g=f==a?g+('<li class="active"><a href="'+d+f+'">'+f+"</a></li>"):g+('<li><a href="'+d+f+'">'+f+"</a></li>");return g};9>this.searchOpts.totalPages?b+=c(1,this.searchOpts.totalPages):5>=a?(b+=c(1,8),b=b+'<li class="disabled"><span>...</span></li>'+('<li><a href="'+d+(this.searchOpts.totalPages-1)+'">'+(this.searchOpts.totalPages-
1)+"</a></li>"),b+='<li><a href="'+d+this.searchOpts.totalPages+'">'+this.searchOpts.totalPages+"</a></li>"):4<a&&a<this.searchOpts.totalPages-4?(b=b+('<li><a href="'+d+'1">1</a></li>')+('<li><a href="'+d+'2">2</a></li>')+'<li class="disabled"><span>...</span></li>'+c(a-2,a+2),b=b+'<li class="disabled"><span>...</span></li>'+('<li><a href="'+d+(this.searchOpts.totalPages-1)+'">'+(this.searchOpts.totalPages-1)+"</a></li>"),b+='<li><a href="'+d+this.searchOpts.totalPages+'">'+this.searchOpts.totalPages+
"</a></li>"):b=b+('<li><a href="'+d+'1">1</a></li>')+('<li><a href="'+d+'2">2</a></li>')+'<li class="disabled"><span>...</span></li>'+c(this.searchOpts.totalPages-6,this.searchOpts.totalPages);return b+"</ul>"},updateShareFields:function(){$("#link").html(this.shareFieldsTemplate({shareUrl:location.href}))}});window.AppRouter=Backbone.Router.extend();window.AppView=Backbone.View.extend({Collections:{Locations:{}},Views:{Panel:{},CampusMap:{}},Router:{},el:$("#campusmap-ui"),events:{"click a#map-options-toggler":"togglePanelDisplay",
"click #map-results-pagination a":"paginate","click a.kwsearch-clear":"clearResults","submit form#marker-search":"searchByKeyword","change select#bldgsearch-select":"searchByBuilding"},initialize:function(){var a=this;this.Collections.Locations=new LocationCollection;this.Collections.Locations.fetch();this.Router=new AppRouter;this.Views.CampusMap=new MapView({collection:this.Collections.Locations,router:this.Router});this.Views.Panel=new PanelView({collection:this.Collections.Locations,router:this.Router});
this.Views.Panel.routeUrl=this.getRouteUrl();this.Views.Panel.updateShareFields();var b=function(b,c){c=parseFloat(c)||1;b=unescape(b.replace("+"," "));""!==b?(a.Collections.Locations.removeShownMarkers(),_.delay(function(){a.Views.Panel.routeUrl=a.getRouteUrl();a.Views.Panel.searchByKeyword(b,c);a.Views.Panel.updateShareFields()},300)):a.clearResults()};this.Router.route("","",function(){a.Collections.Locations.removeShownMarkers();a.Views.Panel.routeUrl="";a.Views.Panel.clearResults();a.Views.Panel.updateShareFields()});
this.Router.route("search/:query","search",b);this.Router.route("search/:query/p:page","search",b);this.Router.route("locations/:ids","locations",function(b){b=b.split(",");a.Collections.Locations.removeShownMarkers();_.delay(function(){a.Views.Panel.routeUrl=a.getRouteUrl();a.Views.Panel.searchByIDs(b);a.Views.Panel.updateShareFields()},300)});Backbone.history.start()},searchByKeyword:function(a){a.preventDefault();this.Router.navigate("search/"+escape($("#kwsearch-keyword").val()),!0)},searchByBuilding:function(a){a.preventDefault();
this.Router.navigate("locations/"+escape(a.currentTarget.value),!0)},paginate:function(a){a=parseInt(a.currentTarget.innerHTML);if("number"!==typeof a||isNaN(a))a=1;this.Views.Panel.updateShareFields();this.Views.Panel.updateResults(a)},getRouteUrl:function(){var a=""!==location.hash?location.hash.match(/^#([a-z0-9,%-]*\/?){2}/)[0]:"#";return"/"!==a.charAt(a.length-1)?a+"/":a},clearResults:function(a){a.preventDefault();this.Router.navigate("",!0)},togglePanelDisplay:function(){var a=this;0>this.Views.Panel.$("#features-panel").offset().left?
($("#features-panel, #map-canvas").animate({left:"0px"},100,"linear"),$("#options-nav-bar").animate({left:"0px",height:"29px",padding:"15px"},100,"linear",function(){$("#map-options-toggler").attr("title","Close this sidebar").css({backgroundPosition:"48% 4px",top:"17px",right:"10px"})})):($("#features-panel, #map-canvas").animate({left:"-340px"},100,"linear",function(){a.Views.CampusMap.resizeMap()}),$("#options-nav-bar").animate({left:"-300px",height:"10px",padding:"5px"},100,"linear",function(){$("#map-options-toggler").attr("title",
"Open this sidebar").css({backgroundPosition:"48% -28px",top:"-1px",right:"-2px"})}));return!1}});window.App=new AppView});