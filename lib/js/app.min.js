$(function(){window.Location=Backbone.Model.extend({defaults:{label:0,showOnMap:!1,showInfowindow:!1,marker:null},initialize:function(){var a=this.toJSON();this.set({marker:new google.maps.Marker({position:new google.maps.LatLng(parseFloat(a.lat),parseFloat(a.lng)),title:a.name,map:null,icon:"http://maps.google.com/mapfiles/marker"+String.fromCharCode(a.label+65)+".png"})})}});window.LocationCollection=Backbone.Collection.extend({model:Location,url:"lib/data/markers.json",initialize:function(){this.bind("change:label",
this.updateMarkerIcon)},searchByQuery:function(a){return this.filter(function(b){var c=RegExp(a,"i");return c.test(b.get("name"))||c.test(b.get("keywords"))||c.test(b.get("address"))||c.test(b.get("id"))||-1!==_.indexOf(b.get("departments"),a)?!0:!1})},searchById:function(a){return this.filter(function(b){return parseInt(b.get("id"))===parseInt(a)})},getShownMarkers:function(){return this.filter(function(a){return null!==a.get("marker").getMap()})},removeShownMarkers:function(){var a=this.getShownMarkers();
0<a.length&&_.each(a,function(a){var c=a.get("marker");a.set({showOnMap:!1,showInfowindow:!1});c.setMap(null);google.maps.event.clearListeners(c,"click")})},updateMarkerIcon:function(a){var b=a.get("marker"),a=a.get("label");b.setIcon("http://maps.google.com/mapfiles/marker"+String.fromCharCode(a+65)+".png")}});window.MapView=Backbone.View.extend({el:$("#map-canvas"),infoWindowTemplate:_.template($("#marker-infowindow-content").html()),map:null,defaults:{center:null,zoom:16},mapCenter:null,kmlVersion:"1.4.6",
layers:{kml:[],bldgLayers:["academicsLayer","administrativeLayer","dormLayer"],infoLayers:["muathleticLayer"]},markers:[],infowindow:null,initialize:function(){var a=this;this.defaults.center=new google.maps.LatLng(39.996635,-76.353929);this.map=new google.maps.Map(this.el[0],{zoom:this.defaults.zoom,zoomControl:!0,panControl:!1,center:this.defaults.center,mapTypeId:google.maps.MapTypeId.ROADMAP});this.collection.bind("change:showOnMap",this.addMarker,this);this.showKmlLayer("baseLayer",{url:"http://www.millersville.edu/dev/directions/data/markers.kml",
suppressInfoWindows:!0,preserveViewport:!0});$("#filter-map").on("change","input.filter-checkbox",function(){if(!0===this.checked){var b=-1!==_.indexOf(a.layers.bldgLayers,this.id,!0);a.showKmlLayer(this.id,{url:this.value,suppressInfoWindows:!0,preserveViewport:!0});if("baseLayer"!==this.id&&b&&!0===document.getElementById("baseLayer").checked)document.getElementById("baseLayer").checked=!1,a.removeKmlLayer("baseLayer");else if("baseLayer"===this.id)for(b=0;b<a.layers.bldgLayers.length;b++)!0==document.getElementById(a.layers.bldgLayers[b]).checked&&
(document.getElementById(a.layers.bldgLayers[b]).checked=!1,a.removeKmlLayer(a.layers.bldgLayers[b]))}else a.removeKmlLayer(this.id)})},resizeMap:function(){google.maps.event.trigger(this.map,"resize");null!==this.infowindow&&this.map.setCenter(this.infowindow.position)},resetMap:function(){this.map.panTo(this.defaults.center);this.map.setZoom(this.defaults.zoom);this.setInfoWindow(null)},addMarker:function(a){var b=this,c=a.toJSON(),d=c.marker;d.setMap(this.map);google.maps.event.addListener(d,"click",
function(){var e=new google.maps.InfoWindow({content:b.infoWindowTemplate({marker:c}),position:d.getPosition()});google.maps.event.addListener(e,"closeclick",function(){a.set({showInfowindow:!1})});a.set({showInfowindow:!0});b.setInfoWindow(e);e.open(b.map,d)})},openMarkerInfowindow:function(a){var b=a.get("marker");!0===a.get("showInfowindow")&&null!==b.getMap()?google.maps.event.trigger(b,"click"):this.setInfoWindow(null)},setInfoWindow:function(a){null!==this.infowindow&&this.infowindow.close();
this.infowindow=a},showKmlLayer:function(a,b){void 0===this.layers.kml[a]&&(this.layers.kml[a]=new google.maps.KmlLayer(b.url+"?v="+this.kmlVersion,{suppressInfoWindows:b.suppressInfoWindows,preserveViewport:b.preserveViewport}));this.layers.kml[a].setMap(this.map);this.addKMLLayerClickEvent(a)},addKMLLayerClickEvent:function(a){var b=this;("baseLayer"===a||-1!==_.indexOf(b.layers.bldgLayers,a,!0)||-1!==_.indexOf(b.layers.infoLayers,a,!0))&&google.maps.event.addListener(b.layers.kml[a],"click",function(a){a=
new google.maps.InfoWindow({content:a.featureData.infoWindowHtml,position:new google.maps.LatLng(a.latLng.lat(),a.latLng.lng())});b.setInfoWindow(a);a.open(b.map)})},removeKmlLayer:function(a){this.layers.kml[a].setMap(null)}});window.PanelView=Backbone.View.extend({el:$("#panel-wrapper"),statsTemplate:_.template($("#search-results-stats").html()),resultsTemplate:_.template($("#search-results-item").html()),shareFieldsTemplate:_.template($("#share-fields").html()),searchResults:[],searchOpts:{curPage:1,
totalPages:1,pageSize:6},routeUrl:"",events:{},initialize:function(){var a=this;this.input=this.$("#kwsearch-keyword");this.selectbox=this.$("#bldgsearch-select");this.deepLinksIds=[];$("#options-nav-bar").find("a:first").addClass("selected");$("#map-search").show();0===a.searchResults.length&&$("#map-overlays").show();$("#options-nav-bar").on("click","a.btn",function(){$("#options-nav-bar").find("a").removeClass("active");$(this).addClass("active");$("fieldset",$("#marker-search")).hide();$("#sharedlink").blur();
switch(this.id){case "tablink-mapoptions":$("#map-search, #link").hide();$("#map-overlays").show();break;case "tablink-link":$("#map-search, #map-overlays").hide();$("#link").show();$("#sharedlink").focus().select();break;default:$("#link").hide(),$("#map-search").show(),$("fieldset"+$(this).attr("href"),$("#marker-search")).show(),""===a.input.val()&&0===a.searchResults.length?$("#map-overlays").show():$("#map-overlays").hide()}return!1})},setCurrentPage:function(a){this.searchOpts.curPage="number"!==
typeof a||1>a||a>this.searchOpts.totalPages?1:a},searchByKeyword:function(a,b){this.input.val(a);this.searchResults=this.collection.searchByQuery(a);this.searchOpts.totalPages=Math.ceil(this.searchResults.length/this.searchOpts.pageSize);this.setCurrentPage(b);this.selectbox[0].selectedIndex=0;this.updateResults();return!1},searchByIDs:function(a){var b=0;this.searchResults=[];for(this.deepLinksIds=a||[];b<this.deepLinksIds.length;b++){var c=this.collection.get(this.deepLinksIds[b]);void 0!==c&&this.searchResults.push(c)}1===
this.searchResults.length?(this.input.val(this.searchResults[0].get("name")),this.selectbox.val(a[0])):(this.input.val(""),this.selectbox[0].options.selectedIndex=0);this.searchOpts.totalPages=Math.ceil(this.searchResults.length/this.searchOpts.pageSize);this.updateResults()},updateResults:function(){var a=this,b=this.searchOpts.curPage;Math.ceil(this.searchResults.length/this.searchOpts.pageSize);var c="",d=(b-1)*this.searchOpts.pageSize,e=d+this.searchOpts.pageSize,e=e<=this.searchResults.length?
e:this.searchResults.length;$("#map-overlays").css({display:"none"});$(".kwsearch-clear").css({display:"block"});if(1>this.searchResults.length)$("#map-results").html('<div class="alert alert-block"><p>No results were found for <strong><em>'+(""!==this.selectbox.val()?this.selectbox.val():this.input.val())+"</em></strong>.<br /><br />Please make sure building or department names are spelled correctly.</p></div>");else{c='<ul id="results-page-'+b+'" class="page active">';for(b=d;b<e;b++)c+=this.resultsTemplate({id:this.searchResults[b].id,
label:b%this.searchOpts.pageSize,marker:this.searchResults[b].toJSON()});c+="</ul>";$("#map-results-stats").html(this.statsTemplate({lowerBound:d,upperBound:e,resultCount:this.searchResults.length,query:this.input.val()}));$("#map-results").html(c);$("#map-results li").on("click","a",function(){var b=a.collection.get(this.id.replace("result-",""));google.maps.event.trigger(b.get("marker"),"click");return!1});$("#map-results-pagination").html(this.renderPagination());if(1===this.searchResults.length)c=
this.collection.get(this.searchResults[0].id),c.set({showOnMap:!0,showInfowindow:!0,label:0}),google.maps.event.trigger(c.get("marker"),"click");else for(b=d;b<e;b++)c=this.collection.get(this.searchResults[b].id),c.set({showOnMap:!0,showInfowindow:!1,label:b%this.searchOpts.pageSize})}$("#map-results-wrap").css({display:"block"})},clearResults:function(){$("#map-results-pagination, #map-results-feedback, #map-results").html("");$("#map-results-wrap, .kwsearch-clear").css({display:"none"});$("#map-overlays").css({display:"block"});
this.input.val("");this.selectbox[0].options.selectedIndex=0;this.searchOpts.curPage=1;this.searchResults=[]},renderPagination:function(){var a=1>=this.searchOpts.curPage?1:parseInt(this.searchOpts.curPage),b="<ul>",c=this.routeUrl+"p",d=function(b,d){for(var g="",f=b;f<=d;f++)g=f==a?g+('<li class="active"><a href="'+c+f+'">'+f+"</a></li>"):g+('<li><a href="'+c+f+'">'+f+"</a></li>");return g};9>this.searchOpts.totalPages?b+=d(1,this.searchOpts.totalPages):5>=a?(b+=d(1,8),b=b+'<li class="disabled"><span>...</span></li>'+
('<li><a href="'+c+(this.searchOpts.totalPages-1)+'">'+(this.searchOpts.totalPages-1)+"</a></li>"),b+='<li><a href="'+c+this.searchOpts.totalPages+'">'+this.searchOpts.totalPages+"</a></li>"):4<a&&a<this.searchOpts.totalPages-4?(b=b+('<li><a href="'+c+'1">1</a></li>')+('<li><a href="'+c+'2">2</a></li>')+'<li class="disabled"><span>...</span></li>'+d(a-2,a+2),b=b+'<li class="disabled"><span>...</span></li>'+('<li><a href="'+c+(this.searchOpts.totalPages-1)+'">'+(this.searchOpts.totalPages-1)+"</a></li>"),
b+='<li><a href="'+c+this.searchOpts.totalPages+'">'+this.searchOpts.totalPages+"</a></li>"):b=b+('<li><a href="'+c+'1">1</a></li>')+('<li><a href="'+c+'2">2</a></li>')+'<li class="disabled"><span>...</span></li>'+d(this.searchOpts.totalPages-6,this.searchOpts.totalPages);return b+"</ul>"},updateShareFields:function(){$("#link").html(this.shareFieldsTemplate({shareUrl:location.href}))}});window.AppRouter=Backbone.Router.extend();window.AppView=Backbone.View.extend({Collections:{Locations:{}},Views:{Panel:{},
CampusMap:{}},Router:{},el:$("#campusmap-ui"),events:{"click a#map-options-toggler":"togglePanelDisplay","click #map-results-pagination a":"paginate","click a.kwsearch-clear":"clearResults","submit form#marker-search":"searchByKeyword","change select#bldgsearch-select":"searchByBuilding"},initialize:function(){var a=this;this.Collections.Locations=new LocationCollection;this.Collections.Locations.fetch();this.Router=new AppRouter;this.Views.CampusMap=new MapView({collection:this.Collections.Locations,
router:this.Router});this.Views.Panel=new PanelView({collection:this.Collections.Locations,router:this.Router});this.Views.Panel.routeUrl=this.getRouteUrl();this.Views.Panel.updateShareFields();var b=function(b,d){d=parseFloat(d)||1;b=unescape(b.replace("+"," "));""!==b?(a.Collections.Locations.removeShownMarkers(),a.trackVirtualPageView(),_.delay(function(){a.Views.Panel.routeUrl=a.getRouteUrl();a.Views.Panel.searchByKeyword(b,d);a.Views.Panel.updateShareFields()},300)):a.clearResults()};this.Router.route("",
"",function(){a.Collections.Locations.removeShownMarkers();a.Views.Panel.routeUrl="";a.Views.Panel.clearResults();a.trackVirtualPageView();a.Views.Panel.updateShareFields();a.Views.CampusMap.resetMap();return!1});this.Router.route("search/:query","search",b);this.Router.route("search/:query/p:page","search",b);this.Router.route("locations/:ids","locations",function(b){b=b.split(",");a.Collections.Locations.removeShownMarkers();a.trackVirtualPageView();_.delay(function(){a.Views.Panel.routeUrl=a.getRouteUrl();
a.Views.Panel.searchByIDs(b);a.Views.Panel.updateShareFields()},300)});Backbone.history.start()},searchByKeyword:function(a){a.preventDefault();this.Router.navigate("search/"+escape($("#kwsearch-keyword").val()),!0)},searchByBuilding:function(a){a.preventDefault();this.Router.navigate("locations/"+escape(a.currentTarget.value),!0)},paginate:function(a){a=parseInt(a.currentTarget.innerHTML);if("number"!==typeof a||isNaN(a))a=1;this.Views.Panel.updateShareFields();this.trackVirtualPageView();this.Views.Panel.updateResults(a)},
getRouteUrl:function(){var a=""!==location.hash?location.hash.match(/^#([a-z0-9,%-]*\/?){2}/)[0]:"#";return"/"!==a.charAt(a.length-1)?a+"/":a},clearResults:function(){this.Router.navigate("",!0)},trackVirtualPageView:function(){_gaq&&"object"===typeof _gaq&&_gaq.push(["_trackPageview",location.pathname+location.search+location.hash])},togglePanelDisplay:function(){var a=this;0>this.Views.Panel.$("#features-panel").offset().left?($("#features-panel, #map-canvas").animate({left:"0px"},100,"linear"),
$("#map-canvas").animate({left:"340px"},100,"linear",function(){a.Views.CampusMap.resizeMap()}),$("#options-nav-bar").animate({left:"0px",height:"29px",top:"0px",padding:"15px"},100,"linear",function(){$("#map-options-toggler").attr({title:"Close this sidebar","class":"icon-chevron-left"}).css({top:"19px",right:"15px"})})):($("#features-panel, #map-canvas").animate({left:"-340px"},100,"linear",function(){a.Views.CampusMap.resizeMap()}),$("#options-nav-bar").animate({left:"-300px",height:"10px",padding:"5px"},
100,"linear",function(){$("#map-options-toggler").attr({title:"Open this sidebar","class":"icon-chevron-right"}).css({top:"1px",right:"-2px"})}));return!1}});window.App=new AppView});